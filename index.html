<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CCTV Cameras Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .popup {
      min-width: 280px;
      max-width: 360px;
      font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .popup h3 {
      margin: 0 0 .5rem 0; font-size: 1rem; font-weight: 700;
    }
    .popup .kind {
      margin: .2rem 0 .5rem 0; font-weight: 600; color: #111;
    }
    .popup img {
      display: block; width: 100%; height: auto; border-radius: 6px;
    }
    .field {
      margin-top: .5rem;
    }
    .label {
      font-size: .8rem; text-transform: uppercase; letter-spacing: .02em;
      color: #666; margin-bottom: .2rem; display: block;
    }
    .value {
      color: #111;
      background: #f6f6f6; border: 1px solid #e6e6e6; border-radius: 6px;
      padding: .5rem .6rem; white-space: pre-wrap; word-break: break-word;
    }
    /* Monochrome dot markers */
    .cam-marker {
      background: #111;
      border: 2px solid #fff;
      width: 12px; height: 12px; border-radius: 50%;
      box-shadow: 0 0 0 2px rgba(0,0,0,.15);
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // Create the map
    const map = L.map('map', { scrollWheelZoom: true });

    // Monochrome OSM (Carto Positron)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution:
        '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors ' +
        '&copy; <a href="https://carto.com/">CARTO</a>',
      maxZoom: 20
    }).addTo(map);

    // Small monochrome dot marker
    function dotMarker(latlng) {
      return L.marker(latlng, {
        icon: L.divIcon({ className: 'cam-marker', iconSize: [12, 12] })
      });
    }

    // Safely get the first present property among several candidates
    function getFirstProp(obj, keys) {
      for (const k of keys) {
        if (obj && Object.prototype.hasOwnProperty.call(obj, k) && obj[k] != null && obj[k] !== '') {
          return obj[k];
        }
      }
      return undefined;
    }

    // Escape HTML in any string
    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;').replace(/</g, '&lt;')
        .replace(/>/g, '&gt;').replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // Load your GeoJSON
    fetch('CCTV-Cameras.geojson')
      .then(r => r.json())
      .then(geojson => {
        const layer = L.geoJSON(geojson, {
          pointToLayer: (feature, latlng) => dotMarker(latlng),
          onEachFeature: (feature, marker) => {
            const p = feature.properties || {};

            // Title (fallback to "Camera")
            const title = getFirstProp(p, ['title', 'name']) || 'Camera';

            // --- ABOVE the image: "What kind of camera do you think this is?" ---
            // Try multiple possible keys in case the exact label differs.
            const cameraKind = getFirstProp(p, [
              'What kind of camera do you think this is?',
              'what kind of camera do you think this is?',
              'What_kind_of_camera_do_you_think_this_is?',
              '3_What_kind_of_camer',   // seen variant
              'camera_kind',
              'type',
              'Type'
            ]);

            // Image URL
            const img = getFirstProp(p, ['image_url', 'thumbnail', 'image', 'photo']);

            // --- BELOW the image: Question / Answer fields ---
            const question = getFirstProp(p, ['Question', 'question', 'Prompt', 'prompt']);
            const answer   = getFirstProp(p, ['Answer', 'answer', 'Response', 'response']);

            // Build popup HTML
            let html = `<div class="popup">`;
            html += `<h3>${escapeHtml(title)}</h3>`;

            if (cameraKind) {
              html += `<div class="kind">${escapeHtml(cameraKind)}</div>`;
            }

            if (img) {
              html += `<img src="${encodeURI(img)}" alt="Camera thumbnail" loading="lazy">`;
            } else {
              html += `<div class="value" style="margin:.4rem 0;">No image available</div>`;
            }

            // Question
            html += `<div class="field">` +
                      `<span class="label">Question</span>` +
                      `<div class="value">${escapeHtml(question ?? '—')}</div>` +
                    `</div>`;

            // Answer
            html += `<div class="field">` +
                      `<span class="label">Answer</span>` +
                      `<div class="value">${escapeHtml(answer ?? '—')}</div>` +
                    `</div>`;

            html += `</div>`;

            marker.bindPopup(html, { maxWidth: 380 });
          }
        }).addTo(map);

        // Fit map to data
        try {
          map.fitBounds(layer.getBounds(), { padding: [20, 20] });
        } catch {
          map.setView([51.92, 4.48], 12);
        }
      })
      .catch(err => {
        console.error('Failed to load GeoJSON:', err);
        alert('Could not load CCTV-Cameras.geojson. Is your local server running?');
      });
  </script>
</body>
</html>
