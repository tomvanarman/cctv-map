<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CCTV Map with 50m Radius</title>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .mapboxgl-popup-content { font: 13px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .meta-table { border-collapse: collapse; }
    .meta-table td { padding: 2px 6px; vertical-align: top; }
    .meta-table td.key { color:#555; white-space:nowrap; }
  </style>
</head>
<body>
<div id="map"></div>

<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script>
  // 1) Map init
  mapboxgl.accessToken = pk.eyJ1IjoidG9tdmFuYXJtYW4iLCJhIjoiRDlFeWFVdyJ9.B6ZgpP0CsDlAF1D1emvosg;
  const map = new mapboxgl.Map({
    container: "map",
    style: "mapbox://styles/mapbox/light-v11",
    center: [4.9041, 52.3676], // fallback center (Amsterdam)
    zoom: 12
  });
  map.addControl(new mapboxgl.NavigationControl(), "top-right");

  // Helper: turn properties into a small table
  function propsToHTML(props) {
    if (!props || typeof props !== "object") return "<em>No metadata</em>";
    const rows = Object.entries(props)
      .filter(([k,v]) => v !== null && v !== undefined && String(v).trim() !== "")
      .map(([k,v]) => `<tr><td class="key"><strong>${k}</strong></td><td>${String(v)}</td></tr>`)
      .join("");
    return `<table class="meta-table">${rows || "<tr><td><em>No metadata</em></td></tr>"}</table>`;
  }

  async function load() {
    // 2) Load your cameras GeoJSON (keep the file right next to this HTML file)
    //    Use a relative path so it works on GitHub Pages and Squarespace code blocks.
    const url = "./cameras.geojson";
    const res = await fetch(url);
    if (!res.ok) throw new Error(`Failed to load ${url}`);
    const cameras = await res.json();

    // 3) Make 50m buffers around each point on the client (no extra files!)
    //    Works even if your input is Feature or FeatureCollection.
    const pts = cameras.type === "FeatureCollection" ? cameras : { type:"FeatureCollection", features:[cameras] };
    const buffers = turf.buffer(pts, 50, { units: "meters" }); // 50m

    // 4) Fit to data (if any)
    if (pts.features.length) {
      const bbox = turf.bbox(buffers);
      map.fitBounds([[bbox[0], bbox[1]], [bbox[2], bbox[3]]], { padding: 40, maxZoom: 16 });
    }

    // 5) Add sources
    map.addSource("cameras", { type: "geojson", data: pts });
    map.addSource("buffers", { type: "geojson", data: buffers });

    // 6) Buffer styling (fill + outline)
    map.addLayer({
      id: "buffer-fill",
      type: "fill",
      source: "buffers",
      paint: {
        "fill-color": "#3b82f6",
        "fill-opacity": 0.12
      }
    });
    map.addLayer({
      id: "buffer-outline",
      type: "line",
      source: "buffers",
      paint: {
        "line-color": "#3b82f6",
        "line-width": 1.2,
        "line-opacity": 0.8
      }
    });

    // 7) Point styling
    map.addLayer({
      id: "cameras-points",
      type: "circle",
      source: "cameras",
      paint: {
        "circle-radius": 5,
        "circle-color": "#1f2937",
        "circle-stroke-width": 1.5,
        "circle-stroke-color": "#fff"
      }
    });

    // 8) Popups on click
    const popup = new mapboxgl.Popup({ closeButton: true, closeOnClick: true });
    map.on("click", "cameras-points", (e) => {
      const feature = e.features[0];
      const coords = feature.geometry.type === "Point"
        ? feature.geometry.coordinates.slice()
        : e.lngLat.toArray();

      // Popup title: try common fields, else fallback
      const p = feature.properties || {};
      const title = p.name || p.type || p.id || "CCTV camera";

      popup
        .setLngLat(coords)
        .setHTML(`<h3 style="margin:0 0 6px 0;font-size:14px;">${title}</h3>${propsToHTML(p)}`)
        .addTo(map);
    });

    map.on("mouseenter", "cameras-points", () => map.getCanvas().style.cursor = "pointer");
    map.on("mouseleave", "cameras-points", () => map.getCanvas().style.cursor = "");
  }

  map.on("load", () => {
    load().catch(err => {
      console.error(err);
      alert("Could not load cameras.geojson. Open the browser console for details.");
    });
  });
</script>
</body>
</html>
