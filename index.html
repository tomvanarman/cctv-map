<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CCTV Map</title>

  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <style>
    html, body, #map { height: 100%; margin: 0; }
    .popup { max-width: 320px; font: 14px/1.4 -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .popup img { width: 100%; height: auto; display: block; border-radius: 8px; margin-bottom: 8px; }
    .popup .meta { display: grid; grid-template-columns: 1fr; gap: 4px; }
    .popup .meta div { background: #f5f5f5; padding: 6px 8px; border-radius: 6px; overflow-wrap: anywhere; }
    .legend { position: absolute; top: 12px; left: 12px; background: rgba(255,255,255,.95); border-radius: 10px; padding: 10px 12px; box-shadow: 0 4px 16px rgba(0,0,0,.12); font: 13px/1.4 -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; z-index: 1; }
    .swatch { width: 12px; height: 12px; border-radius: 50%; display: inline-block; background: #1d4ed8; margin-right: 6px; vertical-align: -2px; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="legend"><span class="swatch"></span> CCTV camera</div>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoidG9tdmFuYXJtYW4iLCJhIjoiRDlFeWFVdyJ9.B6ZgpP0CsDlAF1D1emvosg';
    var STYLE_URL = 'mapbox://styles/mapbox/standard';
    var GEOJSON_URL = 'CCTV-Cameras.geojson';

    var map = new mapboxgl.Map({
      container: 'map',
      style: STYLE_URL,
      center: [4.468638, 51.914569], // fallback only
      zoom: 15.37,                   // fallback only
      antialias: true
    });

    map.addControl(new mapboxgl.NavigationControl({ visualizePitch: true }), 'top-right');
    map.addControl(new mapboxgl.FullscreenControl(), 'top-right');
    map.addControl(new mapboxgl.ScaleControl({ maxWidth: 160, unit: 'metric' }));
    

    // Load GeoJSON first so we have it ready when the map's style is loaded
    var dataPromise = fetch(GEOJSON_URL).then(function(r){
      if (!r.ok) throw new Error('Failed to load ' + GEOJSON_URL + ' (' + r.status + ')');
      return r.json();
    });
    
    map.on('error', function(e){ console.error('Mapbox error:', e && e.error); });

    map.on('load', function () {
      dataPromise.then(function(geojson){
        // Guarantee a valid FeatureCollection
        if (!geojson || geojson.type !== 'FeatureCollection') {
          console.error('GeoJSON must be a FeatureCollection'); return;
        }

        // Add source
        if (!map.getSource('cctv')) {
          map.addSource('cctv', { type: 'geojson', data: geojson });
        } else {
          map.getSource('cctv').setData(geojson);
        }

        // Add layer
        if (!map.getLayer('cctv-circles')) {
          map.addLayer({
            id: 'cctv-circles',
            type: 'circle',
            source: 'cctv',
            paint: {
              'circle-radius': ['interpolate', ['linear'], ['zoom'], 10, 3, 16, 8],
              'circle-color': '#1d4ed8',
              'circle-opacity': 0.7,
              'circle-stroke-color': '#ffffff',
              'circle-stroke-width': 1
            }
          });
        }

        // Fit bounds once all current style work is idle (prevents “i is undefined” churn)
        map.once('idle', function(){
          try {
            var bounds = new mapboxgl.LngLatBounds();
            (geojson.features || []).forEach(function(f){
              if (f && f.geometry && f.geometry.type === 'Point') {
                var c = f.geometry.coordinates; if (Array.isArray(c) && c.length === 2) bounds.extend([c[0], c[1]]);
              }
            });
            if (!bounds.isEmpty()) {
              map.fitBounds(bounds, { padding: 40, maxZoom: 17 });
            }
          } catch (e) { console.warn('fitBounds failed:', e); }
        });

        // Popups
        map.on('click', 'cctv-circles', function(e){
          var f = e.features && e.features[0]; if (!f) return;
          var p = f.properties || {};

          var title = p.title ? String(p.title) : 'CCTV Camera';
          var imgHtml = '';
          if (p.image_url && String(p.image_url).trim() !== '') {
            imgHtml = '<img src="' + String(p.image_url) + '" alt="Camera photo" loading="lazy">';
          }

          var rows = [];
          function addRow(label, val){
            if (val !== undefined && val !== null && String(val).trim() !== '') {
              rows.push('<div><strong>' + label + ':</strong> ' + String(val) + '</div>');
            }
          }
          addRow('Type', p['3_What_kind_of_camer']);
          addRow('Signage', p['4_Do_you_see_a_sign_']);
          addRow('Owner (guess)', p['5_Who_do_you_think_i']);
          addRow('Purpose (guess)', p['6_What_do_you_think_']);
          addRow('Safety feeling', p['7_How_safe_does_this']);

          var html =
            '<div class="popup">' + imgHtml +
            '<div class="meta"><div><strong>' + title + '</strong></div>' +
            rows.join('') + '</div></div>';

          new mapboxgl.Popup({ closeOnMove: true, offset: 12 })
            .setLngLat(e.lngLat)
            .setHTML(html)
            .addTo(map);
        });

        map.on('mouseenter', 'cctv-circles', function(){ map.getCanvas().style.cursor = 'pointer'; });
        map.on('mouseleave', 'cctv-circles', function(){ map.getCanvas().style.cursor = ''; });

      }).catch(function(err){
        console.error(err);
        alert('Error loading GeoJSON. See console.');
      });
    });
  </script>
</body>
</html>
