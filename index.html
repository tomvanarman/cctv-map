<script>
(function(){
  var GEOJSON_URL = 'cameras-new.geojson';

  // 1. Init the map (we'll fit bounds after loading points)
  var map = L.map('map', {
    zoomControl: true
  });

  // 2. Light grey basemap (Carto light_all on OSM data)
  L.tileLayer(
    'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
    {
      maxZoom: 20,
      attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
    }
  ).addTo(map);

  // We'll collect all latlngs so we can fit bounds
  var allLatLngs = [];

  function buildPopupHTML(props) {
    var cameraType = props.camera_type || 'Camera';
    var imgURL = props.image_url || '';
    var indoorOutdoor = props.indoor_outdoor || '';
    var signage = props.signage_visible || '';

    var html = '<div class="popup-wrapper">';

    // Title (camera_type)
    html += '<div class="popup-title">' + cameraType + '</div>';

    // Thumbnail image (image_url)
    if (imgURL) {
      html += '<img class="popup-thumb" src="' + imgURL + '" alt="Camera image" />';
    }

    // indoor_outdoor
    if (indoorOutdoor) {
      html += '<div class="popup-line"><strong>Indoors / Outdoors:</strong> ' + indoorOutdoor + '</div>';
    }

    // signage_visible
    if (signage) {
      html += '<div class="popup-line"><strong>Signage visible?:</strong> ' + signage + '</div>';
    }

    html += '</div>';
    return html;
  }

  // 3. Load the GeoJSON with your cameras
  fetch(GEOJSON_URL)
    .then(function(resp){
      if (!resp.ok) throw new Error('Failed to load ' + GEOJSON_URL + ' (' + resp.status + ')');
      return resp.json();
    })
    .then(function(geojson){

      // Add each feature as a circleMarker + 50m radius circle
      var layer = L.geoJSON(geojson, {
        pointToLayer: function (feature, latlng) {
          var props = feature.properties || {};

          // main visible marker
          var marker = L.circleMarker(latlng, {
            radius: 6,
            color: '#ffffff',
            weight: 2,
            fillColor: '#1d4ed8',
            fillOpacity: 0.8
          });

          // attach popup
          marker.bindPopup(buildPopupHTML(props));

          // 50m radius circle
          var circle = L.circle(latlng, {
            radius: 50,
            color: '#1d4ed8',
            weight: 1,
            fillColor: '#1d4ed8',
            fillOpacity: 0.15
          });
          circle.addTo(map);

          // collect for fitBounds
          allLatLngs.push(latlng);

          return marker;
        }
      }).addTo(map);

      // Zoom map to all collected points
      if (allLatLngs.length > 0) {
        var bounds = L.latLngBounds(allLatLngs);
        map.fitBounds(bounds.pad(0.2));
      } else {
        // fallback (Amsterdam-ish)
        map.setView([52.3725, 4.9175], 17);
      }
    })
    .catch(function(err){
      console.error(err);
      alert('Could not load cameras-new.geojson. See console for details.');
    });

})();
</script>
