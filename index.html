<link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<style>
  html, body, #map { height: 100%; margin: 0; }
  .thumb { max-width: 220px; max-height: 160px; display: block; }
  .popup { padding: 6px; }
</style>

<div id="map"></div>
<script>
  mapboxgl.accessToken = 'pk.eyJ1IjoidG9tdmFuYXJtYW4iLCJhIjoiRDlFeWFVdyJ9.B6ZgpP0CsDlAF1D1emvosg';

  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [4.47917, 51.9225],
    zoom: 12
  });

  async function loadJSON(path) {
    const res = await fetch(path + '?v=' + Date.now());
    if (!res.ok) throw new Error('Failed to load ' + path);
    return res.json();
  }

  map.on('load', async () => {
    // 1) Always load points
    const points = await loadJSON('cameras.geojson');

    // 2) Try to load precomputed buffers; if not found, compute with Turf
    let buffers;
    try {
      buffers = await loadJSON('buffers-50m.geojson');
      console.log('Using precomputed buffers.');
    } catch (e) {
      console.warn('buffers-50m.geojson not found â€” computing 50m buffers with Turf on the fly.');
      buffers = turf.buffer(points, 50, { units: 'meters' });
    }

    // 3) Add sources
    map.addSource('cameras', { type: 'geojson', data: points });
    map.addSource('buffers', { type: 'geojson', data: buffers });

    // 4) Draw buffers
    map.addLayer({
      id: 'buffers-fill',
      type: 'fill',
      source: 'buffers',
      paint: { 'fill-color': '#3b82f6', 'fill-opacity': 0.15 }
    });
    map.addLayer({
      id: 'buffers-outline',
      type: 'line',
      source: 'buffers',
      paint: { 'line-color': '#3b82f6', 'line-width': 1 }
    });

    // 5) Draw points
    map.addLayer({
      id: 'cameras-points',
      type: 'circle',
      source: 'cameras',
      paint: {
        'circle-radius': 5,
        'circle-color': '#1f2937',
        'circle-stroke-color': '#ffffff',
        'circle-stroke-width': 1
      }
    });

    // 6) Hover popup
    const popup = new mapboxgl.Popup({ closeButton: false, closeOnClick: false, className: 'popup', offset: 12 });

    map.on('mouseenter', 'cameras-points', (e) => {
      map.getCanvas().style.cursor = 'pointer';
      const f = e.features[0];
      const p = f.properties || {};
      const img = p.image_url || p['1_Make_a_photo_of_th'] || '';
      const uuid = p.ec5_uuid || p.ec5_uuid_alias || '';
      popup
        .setLngLat(e.lngLat)
        .setHTML(`
          <div class="popup">
            ${img ? `<img class="thumb" src="${img}" alt="camera ${uuid}" />` : '<em>No image</em>'}
            ${uuid ? `<div style="margin-top:4px;"><strong>${uuid}</strong></div>` : ''}
          </div>
        `)
        .addTo(map);
    });
    map.on('mousemove', 'cameras-points', (e) => popup.setLngLat(e.lngLat));
    map.on('mouseleave', 'cameras-points', () => { map.getCanvas().style.cursor = ''; popup.remove(); });
  });
</script>
